{% load quote_filters %}
{% load static %}
{% load humanize %}

<div class="pq-quote">
    
    <div class="pq-quote-buttons">
        
        <form method="post" action="{% url 'quote_vote' %}" class="vote_form">
            {% csrf_token %}
            <input type="hidden" id="id_quote" name="quote" class="hidden_id" value="{{ quote.pk }}" />
            <input type="hidden" id="id_voter" name="voter" class="hidden_id" value="{{ user.pk }}" />
            <input type="hidden" id="id_vote_type" name="vote_type" class="hidden_id" value="1" />
            {% if not user.is_authenticated %}
                <button onclick="location.href = '/accounts/login/';" class="pq-quote-upvote gray-gradient {{ quote.id | class_if_upvote_active:user.id }}" id="pq-quote-upvote-{{ quote.id }}" title="Please login to vote">
                    <i class="fa fa-arrow-up"></i>
                </button>
            {% else %}
                <button class="pq-quote-upvote gray-gradient {{ quote.id | class_if_upvote_active:user.id }}" id="pq-quote-upvote-{{ quote.id }}">
                    <i class="fa fa-arrow-up"></i>
                </button>
            {% endif %}
        </form>

        <div class="pq-quote-vote-total" id="pq-quote-vote-total-{{ quote.id }}">
            {{ quote.karma_total }}
        </div>
        
        <form method="POST" action="{% url 'quote_vote' %}" class="vote_form">
            {% csrf_token %}
            <input type="hidden" id="id_quote" name="quote" class="hidden_id" value="{{ quote.pk }}" />
            <input type="hidden" id="id_voter" name="voter" class="hidden_id" value="{{ user.pk }}" />
            <input type="hidden" id="id_vote_type" name="vote_type" class="hidden_id" value="-1" />
            {% if not user.is_authenticated %}
                <button onclick="location.href = '/accounts/login/';" class="pq-quote-downvote gray-gradient {{ quote.id | class_if_downvote_active:user.id }}" id="pq-quote-downvote-{{ quote.id }}" title="Please login to vote">
                        <i class="fa fa-arrow-down"></i>
                </button>
            {% else %}
                <button class="pq-quote-downvote gray-gradient {{ quote.id | class_if_downvote_active:user.id }}" id="pq-quote-downvote-{{ quote.id }}">
                        <i class="fa fa-arrow-down"></i>
                </button>
            {% endif %}
        </form>
        
    </div><!-- /.pq-quote-buttons -->
    
    <div class="pq-quote-text-wrapper" id="quote-text-wrapper-{{ forloop.counter }}">
        <div class="pq-quote-title dark-link" style="{% if is_episode_page %} margin-bottom:0;{% endif %}">
            {% if quote.summary %}
                <a href="{{ quote.get_absolute_url }}">
                    {{ quote.summary }}
                </a>
            {% elif not quote.summary %}
                <a href="{{ quote.get_absolute_url }}">
                    {{ quote.converted_time_begins }} 
                    {% if quote.time_quote_ends %}
                        to {{ quote.converted_time_ends }}
                    {% endif %}
                </a>
            {% endif %}
        </div>
        
        {% if is_episode_page %}
        {% else %}
            {% if is_home_page or is_quote_page or is_user_page %}
                {% if quote.episode.podcast.image %}
                    <div class="pq-quote-profile-picture display-none-550px">
                        <a href="{% url 'podcast_quote_list_root' pk=quote.episode.podcast.id %}">
                            <img src="{{MEDIA_URL}}{{ quote.episode.podcast.image }}">
                        </a>
                    </div>
                {% endif %}
            {% endif %}
        
            <div class="pq-quote-subtitle display-none-550px gray-link">
                {% if is_home_page or is_quote_page or is_user_page %}
                    {% if quote.episode.podcast.title %}
                        <a href="{% url 'podcast_quote_list_root' pk=quote.episode.podcast.id %}">
                            Podcast: {{ quote.episode.podcast.title|truncatechars:23 }}
                        </a>
                        <br>
                    {% endif %}
                {% endif %}
                
                {% if is_home_page or is_podcast_page or is_quote_page or is_user_page %}
                    {% if quote.episode.title %} 
                        <a href="{% url 'episode_quote_list_root' pk=quote.episode.id %}">
                           Episode: {{ quote.episode.title|truncatechars:23 }}
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}
        
        {% if is_episode_page %}
        {% else %}
            {% if is_home_page or is_quote_page or is_user_page %}
                {% if quote.episode.podcast.image %}
                    <div class="pq-quote-xs-profile-picture display-none-549px">
                        <a href="{% url 'podcast_quote_list_root' pk=quote.episode.podcast.id %}">
                            <img src="{{MEDIA_URL}}{{ quote.episode.podcast.image }}">
                        </a>
                    </div>
                {% endif %}
            {% endif %}
        
            <div class="pq-quote-xs-subtitle display-none-549px gray-link">
                {% if is_home_page or is_quote_page or is_user_page %}
                    {% if quote.episode.podcast.title %}
                        <a href="{% url 'podcast_quote_list_root' pk=quote.episode.podcast.id %}">
                            Podcast: {{ quote.episode.podcast.title|truncatechars:50 }}
                        </a>
                        <br>
                    {% endif %}
                {% endif %}
                
                {% if is_home_page or is_podcast_page or is_quote_page or is_user_page %}
                    {% if quote.episode.title %} 
                        <a href="{% url 'episode_quote_list_root' pk=quote.episode.id %}">
                           Episode: {{ quote.episode.title|truncatechars:50 }}
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}
        
        <div class="pq-quote-xs-buttons hidden-sm hidden-md hidden-lg">
            <form method="POST" action="{% url 'quote_vote' %}" class="vote_form">
                {% csrf_token %}
                <input type="hidden" id="id_quote" name="quote" class="hidden_id" value="{{ quote.pk }}" />
                <input type="hidden" id="id_voter" name="voter" class="hidden_id" value="{{ user.pk }}" />
                <input type="hidden" id="id_vote_type" name="vote_type" class="hidden_id" value="1" />
                {% if not user.is_authenticated %}
                    <button onclick="location.href = '/accounts/login/';" class="pq-quote-xs-upvote gray-gradient {{ quote.id | class_if_upvote_active:user.id }}" id="pq-quote-xs-upvote-{{ quote.id }}" title="Please login to vote">
                        <i class="fa fa-arrow-up"></i>
                    </button>
                {% else %}
                    <button class="pq-quote-xs-upvote gray-gradient {{ quote.id | class_if_upvote_active:user.id }}" id="pq-quote-xs-upvote-{{ quote.id }}">
                        <i class="fa fa-arrow-up"></i>
                    </button>
                {% endif %}
            </form>
            
            <div class="pq-quote-xs-vote-total" id="pq-quote-xs-vote-total-{{ quote.id }}">
                {{ quote.karma_total }}
            </div>
            
            <form method="POST" action="{% url 'quote_vote' %}" class="vote_form">
                {% csrf_token %}
                <input type="hidden" id="id_quote" name="quote" class="hidden_id" value="{{ quote.pk }}" />
                <input type="hidden" id="id_voter" name="voter" class="hidden_id" value="{{ user.pk }}" />
                <input type="hidden" id="id_vote_type" name="vote_type" class="hidden_id" value="-1" />
                {% if not user.is_authenticated %}
                    <button onclick="location.href = '/accounts/login/';" class="pq-quote-xs-downvote gray-gradient {{ quote.id | class_if_downvote_active:user.id }}" id="pq-quote-xs-downvote-{{ quote.id }}" title="Please login to vote">
                        <i class="fa fa-arrow-down"></i>
                    </button>
                {% else %}
                    <button class="pq-quote-xs-downvote gray-gradient {{ quote.id | class_if_downvote_active:user.id }}" id="pq-quote-xs-downvote-{{ quote.id }}">
                        <i class="fa fa-arrow-down"></i>
                    </button>
                {% endif %}
            </form>
            
        </div><!-- /.pq-quote-xs-buttons -->
        
        {% if is_home_page or is_podcast_page or is_episode_page or is_user_page %}
            <div class="youtube-start-button-wrapper" style="{% if not quote.episode.youtube_url %} display:none; {% endif %}" id="youtube-start-button-wrapper-{{ forloop.counter }}">
                {% if quote.episode.youtube_url %}    
                    <div class="youtube-start-button fa fa-play light-blue-gradient" id="{{ quote.episode.video_id }}?rel=0&start={{ quote.time_quote_begins }}&end={{ quote.time_quote_ends }}&autoplay=1&modestbranding=0&showinfo=0&fs=1">
                        <div class="youtube-start-button-text" id="{{ forloop.counter }}">
                            <small>&nbsp</small> PLAY
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
        
        {% if is_quote_page %}
            {% if quote.episode.youtube_url %}    
                <div style="display:block;" class="youtube-player-wrapper">
                    <iframe src="https://www.youtube.com/embed/{{ quote.episode.video_id }}?rel=0&start={{ quote.time_quote_begins }}&end={{ quote.time_quote_ends }}&autoplay=0&modestbranding=0&vq=medium&showinfo=0&fs=1" allowfullscreen>
                    </iframe>
                </div>
            {% endif %}
        {% endif %}
        
        <div class="youtube-player-wrapper" id="youtube-player-wrapper-{{ forloop.counter }}">
        <!-- Insert video onclick of youtube-start-button-wrapper via youtube.js -->
        </div>
        
        {% if not quote.episode.youtube_url %}
            <div style="margin-top:10px;">
            </div>
        {% endif %}
        
        {% if is_home_page or is_podcast_page or is_episode_page or is_quote_page or is_user_page %}
            {% if quote.summary %}
                <div class="pq-quote-text-box">
                    {% if quote.text %}
                        <div class="pq-quote-text-preview" id="pq-quote-text-preview-{{ forloop.counter }}">
                          {{ quote.text|linebreaks|truncatechars:200 }}
                            {% if quote.is_longer_than_200chars %}
                                <span class="pq-show-more" id="show-more-{{ forloop.counter }}">
                                    show
                                </span>
                            {% endif %}
                        </div>
                        <div class="pq-quote-text" id="pq-quote-text-{{ forloop.counter }}">
                          {{ quote.text|linebreaks }}
                            {% if quote.is_longer_than_200chars %}
                                <div class="pq-show-less" id="show-less-{{ forloop.counter }}">
                                    hide
                                </div>
                            {% endif %}
                        </div><!-- /.pq-quote-text -->
                    {% endif %}
                </div><!-- /.pq-quote-text-box -->
            {% endif %}
        {% endif %}
        
        <script>
          $("#show-more-{{ forloop.counter }}").click(function() {
              $("#pq-quote-text-{{ forloop.counter }}").show();
              $("#pq-quote-text-preview-{{ forloop.counter }}").hide();
              $("#show-more-{{ forloop.counter }}").hide();
              $("#show-less-{{ forloop.counter }}").show();
          });
          $("#show-less-{{ forloop.counter }}").click(function() {
              $("#pq-quote-text-preview-{{ forloop.counter }}").show();
              $("#pq-quote-text-{{ forloop.counter }}").hide();
              $("#show-less-{{ forloop.counter }}").hide();
              $("#show-more-{{ forloop.counter }}").show();
          });
        </script>
        
        {% if is_quote_page %}
            <div class="pq-quote-posted-by blue-link">
                posted {{ quote.created_at|naturaltime }} by <a href="{{ quote.submitted_by.userprofile.get_absolute_url }}">{{ quote.submitted_by }}</a>
            </div>
        {% endif %}
  
    </div><!-- /.pq-quote-text-wrapper --> 
    
    <div class="pq-quote-date dark-link">
        <a href="{{ quote.get_absolute_url }}">
            {% if quote.time_quote_ends %}
                Length: {{ quote.duration }}
            {% elif not quote.time_quote_ends %}
                Starts: {{ quote.converted_time_begins }}
            {% endif %}
            
            <!--
            {% if is_home_page or is_podcast_page or is_quote_page or is_user_page %} 
                {% if quote.episode.publication_date %}
                    - Date Aired: {{ quote.episode.publication_date|date:'M d, Y' }}
                {% endif %}
            {% endif %}
            -->
            
            {% if is_home_page or is_podcast_page or is_quote_page or is_user_page or is_episode_page %}
                {% if quote.time_quote_ends %}
                    / {{ quote.converted_time_begins }} 
                    {% if quote.time_quote_ends %}
                        - {{ quote.converted_time_ends }}
                    {% endif %}
                {% endif %}
            {% endif %}
        </a>
    </div>

    <div class="pq-quote-bottom-buttons">
    
        <!-- Button trigger modal -->
        
        <button class="pq-quote-bottom-button" data-toggle="modal" data-target="#quoteShareModal{{ quote.id }}">
            share
        </button>
        
        
        <!-- Modal -->
        <div class="modal fade" id="quoteShareModal{{ quote.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">Copy this link</h4>
                    </div>
                    <div class="modal-body">
                        http://www.podverse.tv{{ quote.get_absolute_url }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div><!-- /.modal fade -->
        
        {% if is_home_page or is_quote_page or is_user_page %}
            {% if quote.episode.donate_url %}
                <div class="pq-quote-bottom-button text-orange">
                    <a href=
                    "{% if quote.episode.donate_url %}
                        {{ quote.episode.donate_url }}
                    {% endif %}"
                    target="_blank">
                        support
                    </a>
                </div>
            {% elif quote.episode.podcast.donate_url %}
                <div class="pq-quote-bottom-button text-orange">
                    <a href=
                    "{% if quote.episode.podcast.donate_url %}
                        {{ quote.episode.podcast.donate_url }}
                    {% endif %}"
                    target="_blank">
                        support
                    </a>
                </div>
            {% endif %}
                
        {% endif %}
        
        {% if is_podcast_page %}
            {% if quote.episode.donate_url %}
                <div class="pq-quote-bottom-button text-orange">
                    <a href=
                    "{% if quote.episode.podcast.donate_url %}
                        {{ quote.episode.podcast.donate_url }}
                    {% endif %}"
                    target="_blank">
                        support
                    </a>
                </div>
            {% endif %}
        {% endif %}
        
        {% if request.user == quote.submitted_by or user.is_superuser %}
            <div class="pq-quote-bottom-button text-purple">
                <a href="{{ quote.get_absolute_url }}edit/">
                    edit clip
                </a>
            </div>
        {% endif %}

        <div class="clearfix">
        </div>
          
    </div><!-- /.pq-quote-bottom -->
  
    <div class="clearfix">
    </div>

</div><!-- /.pq-quote -->

{% if is_quote_page %}    
    {% include 'quote_header.html' %}
    
    <div class="pq-quote-more dark-link">
        <div class="pq-quote-more-headline">
            <a href="{% url 'podcast_quote_list_root' quote.episode.podcast.id %}">More from this podcast</a>
        </div>
        {% for quote in more_podcast_quotes %}
            <hr>
            <a href="{{ quote.get_absolute_url }}">
                <div class="pq-quote-more-image display-none-549px">
                    {% if quote.episode.youtube_url %}
                        <img src="http://img.youtube.com/vi/{{ quote.episode.video_id }}/0.jpg">
                    {% elif quote.episode.image %}
                        <img src="{{MEDIA_URL}}{{ quote.episode.image }}">
                    {% elif quote.episode.podcast.image %}
                        <img src="{{MEDIA_URL}}{{ quote.episode.podcast.image }}">
                    {% endif %}
                </div>
            </a>
            <div class="pq-quote-more-box">
                <div class="pq-quote-more-text">
                    <a href="{{ quote.get_absolute_url }}">
                        <span class="hidden-xs hidden-sm hidden-md">
                            {{ quote.summary }}
                        </span>
                        <span class="hidden-xs hidden-sm hidden-lg">
                            {{ quote.summary}}
                        </span>
                        <span class="display-none-549px hidden-md hidden-lg">
                            {{ quote.summary|truncatechars:125 }}
                        </span>
                        <span class="display-none-550px">
                            {{ quote.summary|truncatechars:100 }}
                        </span>
                    </a>
                    <br>
                    <a style="font-size:13px;" href="{{ quote.episode.get_absolute_url }}">
                        Episode: {{ quote.episode.title|truncatechars:60 }}
                    </a>
                    <br>
                    <a style="font-size:13px;" href="{{ quote.get_absolute_url }}">
                        {% if quote.time_quote_ends %}
                            Length: {{ quote.duration }}
                        {% else %}
                            Starts: {{ quote.converted_time_begins }}
                        {% endif %}
                    </a>
                </div>
            </div>
            <div class="clearfix">
            </div>
        {% endfor %}
    </div>
    <div class="pq-quote-more dark-link">
        <div class="pq-quote-more-headline">
            <a href="{% url 'episode_quote_list_root' quote.episode.id %}">More from this episode</a>
        </div>
        {% for quote in more_episode_quotes %}
            <hr>
            <a href="{{ quote.get_absolute_url }}">
                <div class="pq-quote-more-image display-none-549px">
                    {% if quote.episode.youtube_url %}
                        <img src="http://img.youtube.com/vi/{{ quote.episode.video_id }}/0.jpg">
                    {% elif quote.episode.image %}
                        <img src="{{MEDIA_URL}}{{ quote.episode.image }}">
                    {% elif quote.episode.podcast.image %}
                        <img src="{{MEDIA_URL}}{{ quote.episode.podcast.image }}">
                    {% endif %}
                </div>
            </a>
            <div class="pq-quote-more-box">
                <div class="pq-quote-more-text">
                    <a href="{{ quote.get_absolute_url }}">
                        <span class="hidden-xs hidden-sm hidden-md">
                            {{ quote.summary }}
                        </span>
                        <span class="hidden-xs hidden-sm hidden-lg">
                            {{ quote.summary}}
                        </span>
                        <span class="display-none-549px hidden-md hidden-lg">
                            {{ quote.summary|truncatechars:125 }}
                        </span>
                        <span class="display-none-550px">
                            {{ quote.summary|truncatechars:100 }}
                        </span>
                    </a>
                    <br>
                    <a style="font-size:13px;" href="{{ quote.get_absolute_url }}">
                        {% if quote.time_quote_ends %}
                            Length: {{ quote.duration }}
                        {% else %}
                            Starts: {{ quote.converted_time_begins }}
                        {% endif %}
                    </a>
                </div>
            </div>
            <div class="clearfix">
            </div>
        {% endfor %}
    </div>
{% endif %}
